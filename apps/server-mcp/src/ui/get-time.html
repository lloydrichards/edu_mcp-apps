<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Get Time</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--font-sans, system-ui, sans-serif);
        background: var(--color-background-primary, #fff);
        color: var(--color-text-primary, #111);
      }
      .wrap {
        padding: 16px;
      }
      .card {
        background: var(--color-background-secondary, #f7f7f5);
        border-radius: var(--border-radius-lg, 10px);
        padding: 16px;
        border: 1px solid var(--color-border-secondary, rgba(0, 0, 0, 0.1));
      }
      h1 {
        margin: 0 0 6px;
        font-size: 16px;
        font-weight: 600;
      }
      p {
        margin: 0;
        font-size: 13px;
        color: var(--color-text-secondary, #555);
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
        gap: 12px;
      }
      .time {
        font-size: 14px;
        font-weight: 600;
        font-family: var(--font-mono, ui-monospace, monospace);
      }
      button {
        border: 1px solid var(--color-border-secondary, rgba(0, 0, 0, 0.1));
        cursor: pointer;
        padding: 8px 12px;
        border-radius: var(--border-radius-md, 8px);
        background: var(--color-background-primary, #fff);
        color: var(--color-text-primary, #111);
        font-weight: 600;
        font-size: 12px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .status {
        margin-top: 8px;
        font-size: 12px;
        color: var(--color-text-secondary, #555);
        min-height: 16px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Get Time</h1>
        <p>Simple MCP App example: tool + UI resource.</p>
        <div class="row">
          <span class="time" id="time">Waiting for server...</span>
          <button id="refresh" type="button">Refresh</button>
        </div>
        <div class="status" id="status">Initializing…</div>
      </div>
    </div>
    <script>
      let nextId = 1;
      const timeEl = document.getElementById("time");
      const statusEl = document.getElementById("status");
      const refreshBtn = document.getElementById("refresh");

      function sendRequest(method, params) {
        const id = nextId++;
        window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
        return new Promise((resolve, reject) => {
          function listener(event) {
            if (!event.data || event.data.id !== id) return;
            window.removeEventListener("message", listener);
            if (event.data.result) return resolve(event.data.result);
            reject(event.data.error || new Error("Request failed"));
          }
          window.addEventListener("message", listener);
        });
      }

      function sendNotification(method, params) {
        window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setTime(time) {
        timeEl.textContent = time || "[no time returned]";
      }

      function normalizeTime(value) {
        if (typeof value !== "string") return "";
        try {
          const parsed = JSON.parse(value);
          return typeof parsed === "string" ? parsed : value;
        } catch (_err) {
          return value;
        }
      }

      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || !data.method) return;
        if (data.method === "ui/notifications/tool-result") {
          const time = normalizeTime(data.params?.content?.[0]?.text);
          if (time) {
            setTime(time);
          }
          setStatus("Ready");
        }
      });

      refreshBtn.addEventListener("click", async () => {
        refreshBtn.disabled = true;
        setStatus("Refreshing…");
        try {
          const result = await sendRequest("tools/call", {
            name: "GetTime",
            arguments: {},
          });
          const time = normalizeTime(result?.content?.[0]?.text);
          setTime(time);
          setStatus("Updated");
        } catch (_err) {
          setStatus("Refresh failed");
        } finally {
          refreshBtn.disabled = false;
        }
      });

      sendRequest("ui/initialize", {
        appCapabilities: {},
        appInfo: { name: "get-time", version: "0.1.0" },
        protocolVersion: "2025-06-18",
      }).then(() => {
        sendNotification("ui/notifications/initialized", {});
        setStatus("Ready");
      });
    </script>
  </body>
</html>
