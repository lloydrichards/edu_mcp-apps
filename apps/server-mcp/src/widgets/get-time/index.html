<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Get Time</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css"
    />
    <style>
      :root {
        color-scheme: light;
        --ink: var(--sl-color-neutral-1000, #1b1b1b);
        --ink-soft: var(--sl-color-neutral-600, #5b5b5b);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--sl-font-sans);
        background: transparent;
        color: var(--ink);
      }
      .wrap {
        padding: 12px 14px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      h1 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
      }
      p {
        margin: 0;
        font-size: 12px;
        color: var(--ink-soft);
      }
      .grid {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .row small {
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 10px;
        color: var(--ink-soft);
      }
      .time {
        font-size: 16px;
        font-weight: 600;
        font-family: var(--sl-font-mono);
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .actions sl-button::part(base) {
        font-weight: 600;
      }
      .status {
        margin-top: 6px;
        font-size: 11px;
        color: var(--ink-soft);
        min-height: 16px;
      }
      @media (max-width: 520px) {
        .actions {
          width: 100%;
          justify-content: flex-start;
        }
      }
    </style>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"
    ></script>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <h1>Get Time</h1>
          <p>Client ticks locally. Server refreshes on demand.</p>
        </div>
        <sl-tag size="small" variant="success" id="clientTick">Live</sl-tag>
      </div>

      <div class="grid">
        <div class="row">
          <div>
            <small>Client</small>
            <div class="time" id="clientTime">--:--:--</div>
          </div>
        </div>
        <div class="row">
          <div>
            <small>Server</small>
            <div class="time" id="serverTime">Waiting for server…</div>
          </div>
          <div class="actions">
            <sl-button
              size="small"
              variant="primary"
              id="refresh"
              type="button"
            >
              Refresh
            </sl-button>
          </div>
        </div>
      </div>

      <div class="status" id="status">Initializing…</div>
    </div>
    <script>
      let nextId = 1;
      const clientTimeEl = document.getElementById("clientTime");
      const serverTimeEl = document.getElementById("serverTime");
      const statusEl = document.getElementById("status");
      const refreshBtn = document.getElementById("refresh");
      const clientTick = document.getElementById("clientTick");

      let clientIntervalId = null;

      function sendRequest(method, params) {
        const id = nextId++;
        window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
        return new Promise((resolve, reject) => {
          function listener(event) {
            if (!event.data || event.data.id !== id) return;
            window.removeEventListener("message", listener);
            if (event.data.result) return resolve(event.data.result);
            reject(event.data.error || new Error("Request failed"));
          }
          window.addEventListener("message", listener);
        });
      }

      function sendNotification(method, params) {
        window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function formatClientTime(date) {
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function formatServerTime(value) {
        if (!value) return "[no time returned]";
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) {
          return value;
        }
        return formatClientTime(parsed);
      }

      function setServerTime(time) {
        serverTimeEl.textContent = formatServerTime(time);
      }

      function startClientClock() {
        if (clientIntervalId !== null) return;
        const tick = () => {
          clientTimeEl.textContent = formatClientTime(new Date());
        };
        tick();
        clientIntervalId = window.setInterval(tick, 1000);
        clientTick.textContent = "Live";
        clientTick.setAttribute("variant", "success");
      }

      function normalizeTime(value) {
        if (typeof value !== "string") return "";
        try {
          const parsed = JSON.parse(value);
          return typeof parsed === "string" ? parsed : value;
        } catch (_err) {
          return value;
        }
      }

      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || !data.method) return;
        if (data.method === "ui/notifications/tool-result") {
          const time = normalizeTime(data.params?.content?.[0]?.text);
          if (time) {
            setServerTime(time);
          }
          setStatus("Ready");
        }
      });

      refreshBtn.addEventListener("click", async () => {
        refreshBtn.disabled = true;
        setStatus("Refreshing…");
        try {
          const result = await sendRequest("tools/call", {
            name: "get_time",
            arguments: {},
          });
          const time = normalizeTime(result?.content?.[0]?.text);
          setServerTime(time);
          setStatus("Updated");
        } catch (_err) {
          setStatus("Refresh failed");
        } finally {
          refreshBtn.disabled = false;
        }
      });

      sendRequest("ui/initialize", {
        appCapabilities: {},
        appInfo: { name: "get-time", version: "0.1.0" },
        protocolVersion: "2025-06-18",
      }).then(() => {
        sendNotification("ui/notifications/initialized", {});
        startClientClock();
        setStatus("Ready");
      });
    </script>
  </body>
</html>
